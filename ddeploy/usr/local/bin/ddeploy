#!/usr/bin/env bash

export base="/etc/ddeploy"
export WORKDIR="$PWD"
source $base/helpers/json.sh
source $base/helpers/enviorment.sh

if [ "$#" -lt 1 ]; then
    echo "[ERROR] No command set"
    exit 5
fi

global_command=$base/commands/global/$1/index.sh
if [ -f "$global_command" ]; then
    shift
    $global_command "$@"
    exit 0
fi

if ! isWorkdir $WORKDIR; then
    echo "$(basename "$WORKDIR") is not a runner environment"
    exit 1
fi

if ! load_vars $WORKDIR; then
    exit 1
fi

sub_command="$base/commands/$1/index.sh"
if [ -f "$sub_command" ]; then
    shift
    "$sub_command" "$@"
    exit 0
elif command docker compose "$@" --help >/dev/null; then # Check if the provided command is a valid Docker Compose command
    # Run the Docker Compose command
    docker compose "$@"
    exit 0
else
    "$base/commands/global/help/index.sh"
    echo "ddeploy: $@ is not ddeploy command."
    echo "See 'ddeploy help'"
    exit 6
fi
