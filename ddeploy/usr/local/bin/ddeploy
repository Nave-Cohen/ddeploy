#!/usr/bin/env bash

export base="/etc/ddeploy"
export WORKDIR="$PWD"
export MAIN_DIR="$base"
source $base/helpers/json.sh

if [ "$#" -lt 1 ]; then
    echo "[ERROR] No command set"
    exit 5
fi

global_command=$base/commands/global/$1/index.sh
if [ -f "$global_command" ]; then
    shift
    $global_command "$@"
    exit 0
fi

if ! isWorkdir $WORKDIR; then
    echo "$(basename "$WORKDIR") is not a runner environment"
    exit 6
fi


export $(grep -v '^#' "$WORKDIR/.ddeploy.env" | xargs)
required_variables=("GIT" "BRANCH" "DOMAIN" "MAIL" "BACKEND_IP" "BACKEND_PORT" "MYSQL_PASSWORD" "MYSQL_DATABASE" "MYSQL_USER")
for variable in "${required_variables[@]}"; do
    if [[ -z "${!variable}" ]]; then
        echo "Error: $variable must be defined in .ddeploy.env file"
        exit 1
    fi
done

sub_command="$base/commands/$1/index.sh"
if [ -f "$sub_command" ]; then
    shift
    "$sub_command" "$@"
    exit 0
elif command docker compose "$@" --help >/dev/null 2>&1; then  # Check if the provided command is a valid Docker Compose command
    # Run the Docker Compose command
    docker compose "$@"
    exit 0
else
    "$base/commands/global/help/index.sh"
    echo "ddeploy: $@ is not ddeploy command."
    echo "See 'ddeploy help'"
    exit 6
fi
